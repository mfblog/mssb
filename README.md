# Mosdns + Singbox/Mihomo è™šæ‹Ÿæœºåˆ†æµä»£ç†é¡¹ç›®ï¼ˆçº¯è‡ªç”¨ç‰ˆæœ¬ï¼‰

## é¡¹ç›®ç®€ä»‹

> âš ï¸ æœ¬é¡¹ç›®ä¸ºè‡ªç”¨ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨éƒ¨åˆ† bugï¼Œæ•¬è¯·è§è°…ã€‚
> 
### ä¸»åˆ†æ”¯ Mosdns + Singbox/Mihomo https://github.com/baozaodetudou/mssb
### æ¬¡åˆ†æ”¯ adguard + Mosdns + Singbox/Mihomo https://github.com/baozaodetudou/mssb/tree/ami

å°è£… `mosdns` å’Œ `singbox/mihomo` ä¸¤ä¸ªæœåŠ¡ï¼Œæ—¨åœ¨å®ç°é«˜æ•ˆçš„åˆ†æµä»£ç†åŠŸèƒ½ã€‚

* `mosdns` ä½¿ç”¨ 53 ç«¯å£å¯¹å¤–æä¾› DNS æœåŠ¡ï¼›
* `singbox/mihomo` ä½¿ç”¨ 6666 ç«¯å£ä¸ `mosdns` å¯¹æ¥ï¼Œä»£ç†è½¬å‘ä½¿ç”¨ç»Ÿä¸€çš„ TProxy é«˜æ•ˆç«¯å£ 7896ï¼›
* å‡ºå›½è®¿é—®é€šè¿‡ `mosdns` è½¬å‘åˆ° `singbox/mihomo`ï¼Œå¹¶å¯ç”¨ `fakeip` æ¨¡å¼ï¼ˆä½¿ç”¨ç½‘æ®µ 28.0.0.0/8ï¼‰ï¼Œéœ€åœ¨ä¸»è·¯ç”±ä¸Šæ·»åŠ ç›¸åº”é™æ€è·¯ç”±ï¼›
* æ–‡æ¡£å‚è€ƒï¼š[fakeip.md](docs/fakeip.md)

é¡¹ç›®åŒæ—¶æ•´åˆï¼š

* `filebrowser`ï¼šç”¨äºé…ç½®æ–‡ä»¶çš„å¯è§†åŒ–ç®¡ç†ï¼›
* `zashboard`ï¼š`singbox/mihomo` çš„ Web UI ç•Œé¢ã€‚

æ„Ÿè°¢å„ä½å¤§ä½¬çš„è´¡çŒ®ï¼Œç‰¹åˆ«æ˜¯ PH å’Œ hero ä¸¤ä½å¤§ä½¬çš„æ”¯æŒã€‚
å¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼Œæ„Ÿè°¢ç¾¤å‹æä¾›
![fl.png](docs/png/fl.png)

## é¡¹ç›®åŠŸèƒ½

* âœ… **è¿›ç¨‹ç®¡ç†**ï¼šé€šè¿‡ `supervisor` ç®¡ç†æœåŠ¡è¿›ç¨‹
* âœ… **é«˜æ•ˆåˆ†æµä»£ç†**ï¼š`mosdns` + `singbox/mihomo` åˆ†æµä»£ç†æ¶æ„
* âœ… **å¯è§†åŒ–ç®¡ç†**ï¼šä½¿ç”¨ `filebrowser` ç®¡ç†é…ç½®æ–‡ä»¶
* âœ… **å‰ç«¯ç•Œé¢**ï¼šé€šè¿‡ `zashboard` æä¾›å‹å¥½çš„é…ç½®ç•Œé¢

## æ¶æ„å›¾
![drawio.png](docs/png/drawio.png)

```plaintext
+------------------+           +----------------------+
|     filebrowser  |           |       zashboard      |
+------------------+           +----------------------+
           |                               |
+------------------+           +----------------------+
|      mosdns      | --------> |    singbox/mihomo    |
+------------------+           +----------------------+
```

### æœåŠ¡ç«¯å£åˆ†é…

| æœåŠ¡                 | ç«¯å£   | æè¿°                  |
| ------------------ | ---- | ------------------- |
| filebrowser        | 8088 | æ–‡ä»¶ç®¡ç†ç•Œé¢              |
| supervisor         | 9001 | è¿›ç¨‹ç®¡ç†ç•Œé¢              |
| mosdns             | 53   | DNS æœåŠ¡å…¥å£            |
| singbox DNS æ¥å£     | 6666 | ä¸ mosdns å¯¹æ¥ç«¯å£       |
| socks5ä»£ç†           | 7891 | singbox SOCKS5 ä»£ç†ç«¯å£ |
| TProxyé€æ˜ä»£ç†         | 7896 | é«˜æ•ˆé€æ˜ä»£ç†ç«¯å£            |
| Web UI (zashboard) | 9090 | singbox Web ç•Œé¢      |
### ğŸ‰ æœåŠ¡webè®¿é—®è·¯å¾„ï¼š
* ğŸŒ Mosdns ç»Ÿè®¡ç•Œé¢ï¼šhttp://{Debianä¸»æœºIP}:9099/graphic

* ğŸ“¦ Supervisor ç®¡ç†ç•Œé¢ï¼šhttp://{Debianä¸»æœºIP}:9001

* ğŸ—‚ï¸  æ–‡ä»¶ç®¡ç†æœåŠ¡ Filebrowserï¼šhttp://{Debianä¸»æœºIP}:8088

* ğŸ•¸ï¸  Sing-box/Mihomo é¢æ¿ UIï¼šhttp://{Debianä¸»æœºIP}:9090/ui

## å®‰è£…æ–¹æ³•

### é€‚ç”¨äº Debian 12 ç³»ç»Ÿï¼š

```bash
# è‹¥ä¸»æœºæ— ä»£ç†ï¼Œå¯é€šè¿‡å¯¼å‡ºå±€åŸŸç½‘ä»£ç†ç¯å¢ƒå˜é‡ä¸´æ—¶åŠ é€Ÿå®‰è£…
# ç¤ºä¾‹ï¼šä½¿ç”¨ Mac ä¸Šçš„ surge æˆ– Windows ä¸Šçš„ mihomo å¼€å¯å±€åŸŸç½‘ä»£ç†
export https_proxy=http://192.168.12.239:6152
export http_proxy=http://192.168.12.239:6152
export all_proxy=socks5://192.168.12.239:6153

# æ‹‰å–ä»“åº“å¹¶å®‰è£…ï¼ˆåŒ…å«å®‰è£…ã€å¸è½½ã€å¯åŠ¨ã€åœæ­¢åŠŸèƒ½ï¼‰
git clone --depth=1 https://github.com/baozaodetudou/mssb.git && cd mssb && bash install.sh
```

### å¼€å‘åˆ†æ”¯(ä¸ç¨³å®šæ…ç”¨)
```bash
# è‹¥ä¸»æœºæ— ä»£ç†ï¼Œå¯é€šè¿‡å¯¼å‡ºå±€åŸŸç½‘ä»£ç†ç¯å¢ƒå˜é‡ä¸´æ—¶åŠ é€Ÿå®‰è£…
# ç¤ºä¾‹ï¼šä½¿ç”¨ Mac ä¸Šçš„ surge æˆ– Windows ä¸Šçš„ mihomo å¼€å¯å±€åŸŸç½‘ä»£ç†
export https_proxy=http://192.168.12.239:6152
export http_proxy=http://192.168.12.239:6152
export all_proxy=socks5://192.168.12.239:6153

# æ‹‰å–ä»“åº“å¹¶å®‰è£…ï¼ˆåŒ…å«å®‰è£…ã€å¸è½½ã€å¯åŠ¨ã€åœæ­¢åŠŸèƒ½ï¼‰
git clone https://github.com/baozaodetudou/mssb.git && cd mssb && git checkout dev && bash install.sh
```

### æŸ¥çœ‹æ—¥å¿—
  æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—ï¼š
  
  ```bash
  tail -f /var/log/supervisor/*.log
  ```

## ç®€è¦è¯´æ˜

### 1. filebrowser
* ç«¯å£ï¼š8088
* æœ‰äº›äººä¸æƒ³è¦ç™»å½•å¯ä»¥æ‰§è¡Œä¸‹è¾¹çš„å‘½ä»¤
  ```shell
  # å–æ¶ˆç”¨æˆ·å¯†ç ç™»å½•ç™»å½•åŠŸèƒ½
  supervisorctl stop filebrowser && filebrowser config set --auth.method=noauth -c /mssb/fb/fb.json -d /mssb/fb/fb.db && supervisorctl start filebrowser
  # æ¢å¤ç”¨æˆ·å¯†ç ç™»å½•ç™»å½•åŠŸèƒ½
  supervisorctl stop filebrowser && filebrowser config set --auth.method=json -c /mssb/fb/fb.json -d /mssb/fb/fb.db && supervisorctl start filebrowser
  ```
### 2. supervisor
* ç«¯å£ï¼š9001
### 3. mosdns ç»Ÿè®¡é¡µé¢
* åœ°å€ï¼šhttp\://{Debianä¸»æœºIP}:9099/graphic
### 4. åŠŸèƒ½è¯´æ˜
* `mosdns`ï¼šæä¾› DNS è§£æä¸ç¼“å­˜åŠ é€Ÿï¼›
* `singbox`ï¼šæä¾› SOCKS5 å’Œé€æ˜ä»£ç†ï¼›
* `zashboard`ï¼šé…ç½®å‰ç«¯ç•Œé¢ï¼ŒçŠ¶æ€æ˜¾ç¤ºã€‚

### 5. ä½¿ç”¨æ–¹æ³•

* å®‰è£…å®Œæˆåï¼Œå°†ä¸»è·¯ç”±çš„ DNS è®¾ç½®ä¸º Debian ä¸»æœºçš„ IPï¼›
* mosdnså¯ä»¥é€‰æ‹©æ˜¯å¦å¯ç”¨æŒ‡å®šclientç§‘å­¦å¼€å…³(é»˜è®¤å¯ç”¨)
  * é…ç½®æ–‡ä»¶åœ¨`/mssb/mosdns/sub_config/switch.yaml`ä¸­ switch2 'A'-å¯ç”¨  'B'-ä¸å¯ç”¨
  * UIç•Œé¢ä¹Ÿå¯ä¿®æ”¹ä½†æ˜¯ç›®å‰é‡å¯åä¼šå¤±æ•ˆè¢«yamlé…ç½®æ–‡ä»¶è¦†ç›–
  * ä¸å¯ç”¨çš„è¯å…¨éƒ¨è®¾å¤‡éƒ½ä¼šèµ°ç§‘å­¦
  * å¯ç”¨åªæœ‰`client_ip.txt`æ–‡ä»¶é‡Œçš„å†…ç½‘è®¾å¤‡èµ°ç§‘å­¦
    * è®¾å¤‡åˆ†æµæ§åˆ¶ï¼šå°†éœ€è¦èµ°ä»£ç†çš„è®¾å¤‡ IP æ·»åŠ åˆ° `client_ip.txt` æ–‡ä»¶ä¸­ï¼Œè·¯å¾„ä¸ºï¼š
      ```text
      /mssb/mosdns/client_ip.txt
      ```
    * æ–‡ä»¶ä¸­æœªåˆ—å‡ºçš„ IP åªä½¿ç”¨ mosdns åŠ é€Ÿï¼Œä¸é€šè¿‡ä»£ç†ã€‚
* ç”±äºmosdnså­˜åœ¨ç¼“å­˜é’ˆå¯¹ä¸€ä¸‹ddnsåŸŸåéœ€è¦åŠ è¿› mywhitelist.txt ä¸ç„¶ç”±äºipæ›´æ–°ç¼“å­˜ä¸æ›´æ–°ä¼šå¯¼è‡´è®¿é—®å¤±è´¥
  ```text
  /mssb/mosdns/mywhitelist.txt
  ```
---
* æ˜¯å¦å¯ç”¨å±è”½æ— è§£æç»“æœçš„Aã€AAAAè¯·æ±‚åŠé»‘åå•  'A'-å¯ç”¨  'B'-ä¸å¯ç”¨
  * é…ç½®æ–‡ä»¶åœ¨`/mssb/mosdns/sub_config/switch.yaml`ä¸­ switch1
  * UIç•Œé¢ä¹Ÿå¯ä¿®æ”¹ä½†æ˜¯ç›®å‰é‡å¯åä¼šå¤±æ•ˆè¢«yamlé…ç½®æ–‡ä»¶è¦†ç›–
* æ³„éœ²ç‰ˆæœ¬/ä¸æ³„éœ²ç‰ˆæœ¬å¼€å…³ 'A'-æ³„éœ²  'B'-ä¸æ³„éœ²
  * é…ç½®æ–‡ä»¶åœ¨`/mssb/mosdns/sub_config/switch.yaml`ä¸­ switch3
  * UIç•Œé¢ä¹Ÿå¯ä¿®æ”¹ä½†æ˜¯ç›®å‰é‡å¯åä¼šå¤±æ•ˆè¢«yamlé…ç½®æ–‡ä»¶è¦†ç›–

* PHä½¬åœ¨ç•Œé¢åŠ äº†è½¯å¯åŠ¨ï¼Œæˆ‘è¿™ä¸ªé¡¹ç›®ä¼šç›‘å¬é…ç½®æ–‡ä»¶è¿›è¡Œç¡¬å¯åŠ¨
* æ‰€ä»¥æ²¡å•¥ç‰¹æ®Šæƒ…å†µè¿˜æ˜¯å»ºè®®æ”¹é…ç½®æ–‡ä»¶ç¨³å¦¥UIåªè´Ÿè´£æ˜¾ç¤º

### 6. å…¶ä»–è®¾ç½®
  è¯·åœ¨ä¸»è·¯ç”±ä¸­æ·»åŠ ä»¥ä¸‹è·¯ç”±è§„åˆ™ï¼š
  
  #### ä¸»è·¯ç”± DNS è®¾ç½®/ DHCP DNSè®¾ç½®
  | é…ç½®é¡¹ | å€¼ |
  |--------|-----|
  | DNS æœåŠ¡å™¨ | `{Debianä¸»æœºIP}` |
  
  #### MosDNS å’Œ Mihomo fakeip è·¯ç”±
  | ç›®æ ‡åœ°å€ | ç½‘å…³ |
  |----------|------|
  | 28.0.0.0/8 | `{Debianä¸»æœºIP}` |
  
  #### Telegram è·¯ç”±
  | ç›®æ ‡åœ°å€ | ç½‘å…³ |
  |----------|------|
  | 149.154.160.0/22 | `{Debianä¸»æœºIP}` |
  | 149.154.164.0/22 | `{Debianä¸»æœºIP}` |
  | 149.154.172.0/22 | `{Debianä¸»æœºIP}` |
  | 91.108.4.0/22 | `{Debianä¸»æœºIP}` |
  | 91.108.20.0/22 | `{Debianä¸»æœºIP}` |
  | 91.108.56.0/22 | `{Debianä¸»æœºIP}` |
  | 91.108.8.0/22 | `{Debianä¸»æœºIP}` |
  | 95.161.64.0/22 | `{Debianä¸»æœºIP}` |
  | 91.108.12.0/22 | `{Debianä¸»æœºIP}` |
  | 91.108.16.0/22 | `{Debianä¸»æœºIP}` |
  | 67.198.55.0/24 | `{Debianä¸»æœºIP}` |
  | 109.239.140.0/24 | `{Debianä¸»æœºIP}` |
  
  #### Netflix è·¯ç”±
  | ç›®æ ‡åœ°å€ | ç½‘å…³ |
  |----------|------|
  | 207.45.72.0/22 | `{Debianä¸»æœºIP}` |
  | 208.75.76.0/22 | `{Debianä¸»æœºIP}` |
  | 210.0.153.0/24 | `{Debianä¸»æœºIP}` |
  | 185.76.151.0/24 | `{Debianä¸»æœºIP}` |

## é¡¹ç›®æ¥æºå’Œå‚è€ƒ

* [https://github.com/herozmy/StoreHouse/tree/latest](https://github.com/herozmy/StoreHouse/tree/latest)
* æ„Ÿè°¢è‹±é›„ä½¬çš„è„šæœ¬æ•™ç¨‹
* æ„Ÿè°¢ Phil Horseå¤§ä½¬çš„ mosdnsçš„ä¼˜åŒ–æ‘¸å™¶
* æ„Ÿè°¢ Jimmy Dada å¤§ä½¬æä¾›mosdnså‰ç«¯é¡µé¢
* æ„Ÿè°¢ mosdns/singbox/mihomoçš„å„ä½å¼€å‘å¤§ä½¬ä»¬

æ„Ÿè°¢æ‰€æœ‰æä¾›æ”¯æŒä¸çµæ„Ÿçš„å¼€æºä½œè€…ï¼
