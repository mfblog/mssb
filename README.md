# Mosdns + Singbox/Mihomo è™šæ‹Ÿæœºåˆ†æµä»£ç†é¡¹ç›®ï¼ˆçº¯è‡ªç”¨ç‰ˆæœ¬ï¼‰

## é¡¹ç›®ç®€ä»‹

> âš ï¸ **é‡è¦æç¤º**ï¼šæœ¬é¡¹ç›®ä¸ºè‡ªç”¨ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨éƒ¨åˆ† bugï¼Œæ•¬è¯·è§è°…ã€‚
> 
> âš ï¸ **ç‰ˆæœ¬æ›´æ–°**ï¼š2025.6.23 ä¹‹å‰çš„æ˜¯ v1 ç‰ˆæœ¬ï¼Œç°åœ¨æ˜¯ v2 ç‰ˆæœ¬ã€‚
> å¦‚æœä½ å½“å‰ä½¿ç”¨çš„æ˜¯ v1 ç‰ˆæœ¬ï¼Œå»ºè®®å…ˆåœæ­¢æ‰€æœ‰æœåŠ¡å¹¶æ‰‹åŠ¨åˆ é™¤ç›®å½• `/mssb` åé‡æ–°å®‰è£…æœ¬è„šæœ¬ã€‚

### åˆ†æ”¯è¯´æ˜

- **ä¸»åˆ†æ”¯**ï¼šMosdns + Singbox/Mihomo - [https://github.com/baozaodetudou/mssb](https://github.com/baozaodetudou/mssb)
- **æ¬¡åˆ†æ”¯**ï¼šadguard + Mosdns + Singbox/Mihomo - [https://github.com/baozaodetudou/mssb/tree/ami](https://github.com/baozaodetudou/mssb/tree/ami)
- æ¬¡åˆ†æ”¯è¿˜å¤„äºv1

### é¡¹ç›®æ¦‚è¿°

å°è£… `mosdns` å’Œ `singbox/mihomo` ä¸¤ä¸ªæœåŠ¡ï¼Œæ—¨åœ¨å®ç°é«˜æ•ˆçš„åˆ†æµä»£ç†åŠŸèƒ½ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- `mosdns` ä½¿ç”¨ 53 ç«¯å£å¯¹å¤–æä¾› DNS æœåŠ¡
- `singbox/mihomo` ä½¿ç”¨ 6666 ç«¯å£ä¸ `mosdns` å¯¹æ¥ï¼Œä»£ç†è½¬å‘ä½¿ç”¨TProxy: 7896ä»¥åŠ redirect: 7877
- ä»£ç†è®¿é—®é€šè¿‡ `mosdns` è½¬å‘åˆ° `singbox/mihomo`ï¼Œå¹¶å¯ç”¨ `fakeip` æ¨¡å¼ï¼ˆä½¿ç”¨ç½‘æ®µ 28.0.0.0/8ï¼‰ï¼Œéœ€åœ¨ä¸»è·¯ç”±ä¸Šæ·»åŠ ç›¸åº”é™æ€è·¯ç”±
- æ–‡æ¡£å‚è€ƒï¼š[fakeip.md](docs/fakeip.md)

**é›†æˆç»„ä»¶ï¼š**

- `filebrowser`ï¼šç”¨äºé…ç½®æ–‡ä»¶çš„å¯è§†åŒ–ç®¡ç†
- `zashboard`ï¼š`singbox/mihomo` çš„ Web UI ç•Œé¢

æ„Ÿè°¢å„ä½å¤§ä½¬çš„è´¡çŒ®ï¼Œç‰¹åˆ«æ˜¯ PH å’Œ hero ä¸¤ä½å¤§ä½¬çš„æ”¯æŒã€‚

### ç³»ç»Ÿæ¶æ„å›¾

![ç³»ç»Ÿæ¶æ„å›¾](docs/png/fl.png)

## é¡¹ç›®åŠŸèƒ½

- âœ… **è¿›ç¨‹ç®¡ç†**ï¼šé€šè¿‡ `supervisor` ç®¡ç†æœåŠ¡è¿›ç¨‹
- âœ… **é«˜æ•ˆåˆ†æµä»£ç†**ï¼š`mosdns` + `singbox/mihomo` åˆ†æµä»£ç†æ¶æ„
- âœ… **å¯è§†åŒ–ç®¡ç†**ï¼šä½¿ç”¨ `filebrowser` ç®¡ç†é…ç½®æ–‡ä»¶
- âœ… **å‰ç«¯ç•Œé¢**ï¼šé€šè¿‡ `zashboard` æä¾›å‹å¥½çš„é…ç½®ç•Œé¢

## ç³»ç»Ÿæ¶æ„

![æ¶æ„å›¾](docs/png/drawio.png)

```plaintext
+------------------+           +----------------------+
|     filebrowser  |           |       zashboard      |
+------------------+           +----------------------+
           |                               |
+------------------+           +----------------------+
|      mosdns      | --------> |    singbox/mihomo    |
+------------------+           +----------------------+
```

## æœåŠ¡ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | æè¿°                         |
|------|------|----------------------------|
| filebrowser | 8088 | æ–‡ä»¶ç®¡ç†ç•Œé¢                     |
| supervisor | 9001 | è¿›ç¨‹ç®¡ç†ç•Œé¢                     |
| mosdns | 53 | DNS æœåŠ¡å…¥å£                   |
| mosdns | 7777 | è§£æèŠ‚ç‚¹åŸŸå                     |
| mosdns | 8888 | sing-boxä½¿ç”¨                 |
| mosdns | 2222 | å†…éƒ¨çš„å›½å†…dnsæœåŠ¡å™¨                |
| mosdns | 3333 | è½¬å‘å›½å¤–è¯·æ±‚åˆ°å†…éƒ¨å¸¦è¿‡æœŸç¼“å­˜çš„æœåŠ¡          |
| mosdns | 4444 | å¸¦è¿‡æœŸç¼“å­˜çš„å†…éƒ¨ä½¿ç”¨/å¤–éƒ¨ä½¿ç”¨çš„å›½å¤–dnsæœåŠ¡å™¨   |
| mosdns | 5656 | ä¸»åˆ†æµæœåŠ¡å™¨                     |
| httpä»£ç† | 7890 | singbox/mihomo ç«¯å£          |
| socks5ä»£ç† | 7891 | singbox/mihomo ç«¯å£          |
| æ··åˆç«¯å£ | 7892 | singbox/mihomo ç«¯å£          |
| DNS æ¥å£ | 6666 | singbox/mihomo ä¸ mosdns å¯¹æ¥ |
| TProxyé€æ˜ä»£ç† | 7896 | nftable ç­–ç•¥ä½¿ç”¨               |
| redirectä»£ç† | 7877 | nftable ç­–ç•¥ä½¿ç”¨  |
| Web UI (zashboard) | 9090 | singbox/mihomo Web ç•Œé¢      |

## ğŸ‰ æœåŠ¡ Web è®¿é—®è·¯å¾„

- ğŸŒ **Mosdns ç»Ÿè®¡ç•Œé¢**ï¼š`http://{Debianä¸»æœºIP}:9099/graphic`
- ğŸ“¦ **Supervisor ç®¡ç†ç•Œé¢**ï¼š`http://{Debianä¸»æœºIP}:9001`
- ğŸ—‚ï¸ **æ–‡ä»¶ç®¡ç†æœåŠ¡ Filebrowser**ï¼š`http://{Debianä¸»æœºIP}:8088`
- ğŸ•¸ï¸ **Sing-box/Mihomo é¢æ¿ UI**ï¼š`http://{Debianä¸»æœºIP}:9090/ui`

## å®‰è£…æ–¹æ³•

### é€‚ç”¨äº Debian 12 ç³»ç»Ÿ

```bash
# è‹¥ä¸»æœºæ— ä»£ç†ï¼Œå¯é€šè¿‡å¯¼å‡ºå±€åŸŸç½‘ä»£ç†ç¯å¢ƒå˜é‡ä¸´æ—¶åŠ é€Ÿå®‰è£…
# ç¤ºä¾‹ï¼šä½¿ç”¨ Mac ä¸Šçš„ surge æˆ– Windows ä¸Šçš„ mihomo å¼€å¯å±€åŸŸç½‘ä»£ç†
export https_proxy=http://192.168.12.239:6152
export http_proxy=http://192.168.12.239:6152
export all_proxy=socks5://192.168.12.239:6153

# æ‹‰å–ä»“åº“å¹¶å®‰è£…ï¼ˆåŒ…å«å®‰è£…ã€å¸è½½ã€å¯åŠ¨ã€åœæ­¢åŠŸèƒ½ï¼‰
git clone --depth=1 https://github.com/baozaodetudou/mssb.git && cd mssb && bash install.sh
```

### å¼€å‘åˆ†æ”¯ï¼ˆä¸ç¨³å®šæ…ç”¨ï¼‰

```bash
# è‹¥ä¸»æœºæ— ä»£ç†ï¼Œå¯é€šè¿‡å¯¼å‡ºå±€åŸŸç½‘ä»£ç†ç¯å¢ƒå˜é‡ä¸´æ—¶åŠ é€Ÿå®‰è£…
# ç¤ºä¾‹ï¼šä½¿ç”¨ Mac ä¸Šçš„ surge æˆ– Windows ä¸Šçš„ mihomo å¼€å¯å±€åŸŸç½‘ä»£ç†
export https_proxy=http://192.168.12.239:6152
export http_proxy=http://192.168.12.239:6152
export all_proxy=socks5://192.168.12.239:6153

# æ‹‰å–ä»“åº“å¹¶å®‰è£…ï¼ˆåŒ…å«å®‰è£…ã€å¸è½½ã€å¯åŠ¨ã€åœæ­¢åŠŸèƒ½ï¼‰
git clone https://github.com/baozaodetudou/mssb.git && cd mssb && git checkout dev && bash install.sh
```

### æŸ¥çœ‹æ—¥å¿—

æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—ï¼š

```bash
tail -f /var/log/supervisor/*.log
```

## ä½¿ç”¨è¯´æ˜

### 1. filebrowser

- **ç«¯å£**ï¼š8088
- **ç™»å½•è®¾ç½®**ï¼šæœ‰äº›äººä¸æƒ³è¦ç™»å½•å¯ä»¥æ‰§è¡Œä¸‹è¾¹çš„å‘½ä»¤

```shell
# å–æ¶ˆç”¨æˆ·å¯†ç ç™»å½•åŠŸèƒ½
supervisorctl stop filebrowser && filebrowser config set --auth.method=noauth -c /mssb/fb/fb.json -d /mssb/fb/fb.db && supervisorctl start filebrowser

# æ¢å¤ç”¨æˆ·å¯†ç ç™»å½•åŠŸèƒ½
supervisorctl stop filebrowser && filebrowser config set --auth.method=json -c /mssb/fb/fb.json -d /mssb/fb/fb.db && supervisorctl start filebrowser
```

### 2. supervisor

- **ç«¯å£**ï¼š9001

### 3. mosdns ç»Ÿè®¡é¡µé¢

- **åœ°å€**ï¼š`http://{Debianä¸»æœºIP}:9099/graphic`

### 4. åŠŸèƒ½è¯´æ˜

- `mosdns`ï¼šæä¾› DNS è§£æä¸ç¼“å­˜åŠ é€Ÿ
- `singbox`ï¼šæä¾› SOCKS5 å’Œé€æ˜ä»£ç†
- `zashboard`ï¼šé…ç½®å‰ç«¯ç•Œé¢ï¼ŒçŠ¶æ€æ˜¾ç¤º

### 5. ä½¿ç”¨æ–¹æ³•

#### åŸºæœ¬è®¾ç½®

- å®‰è£…å®Œæˆåï¼Œå°†ä¸»è·¯ç”±çš„ DNS è®¾ç½®ä¸º Debian ä¸»æœºçš„ IP

#### è®¾å¤‡åˆ†æµæ§åˆ¶

mosdns å¯ä»¥é€‰æ‹©æ˜¯å¦å¯ç”¨æŒ‡å®š client ç§‘å­¦å¼€å…³ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼š

- **è§„åˆ™æ–‡ä»¶**ï¼š`switch1.txt-switch9.txt`ï¼Œåœ¨ `rule` æ–‡ä»¶å¤¹å†…
- **é…ç½®æ–‡ä»¶**ï¼š`/mssb/mosdns/sub_config/switch.yaml` ä¸­ `switch2` 
  - `'A'` - å¯ç”¨
  - `'B'` - ä¸å¯ç”¨
- **UI ç•Œé¢**ï¼šä¹Ÿå¯ä¿®æ”¹ï¼Œé‡å¯ä¸ä¼šå¤±æ•ˆ `/mssb/mosdns/rule/switch2.txt`

**åˆ†æµè§„åˆ™ï¼š**
- **ä¸å¯ç”¨**ï¼šå…¨éƒ¨è®¾å¤‡éƒ½ä¼šèµ°ç§‘å­¦
- **å¯ç”¨**ï¼šåªæœ‰ `client_ip.txt` æ–‡ä»¶é‡Œçš„å†…ç½‘è®¾å¤‡èµ°ç§‘å­¦

**è®¾å¤‡åˆ†æµæ§åˆ¶**ï¼šå°†éœ€è¦èµ°ä»£ç†çš„è®¾å¤‡ IP æ·»åŠ åˆ° `client_ip.txt` æ–‡ä»¶ä¸­ï¼š

```text
/mssb/mosdns/client_ip.txt
```

æ–‡ä»¶ä¸­æœªåˆ—å‡ºçš„ IP åªä½¿ç”¨ mosdns åŠ é€Ÿï¼Œä¸é€šè¿‡ä»£ç†ã€‚

#### å…¶ä»–é…ç½®

- **ç™½åå•**ï¼šå¼ºåˆ¶ç”¨å›½å†… DNS è§£æï¼Œæœ‰è¿‡æœŸç¼“å­˜
- **DDNS åŸŸå**ï¼šæ˜¯è‡ªå·±çš„åŸŸåï¼Œæ²¡è¿‡æœŸç¼“å­˜

ç”±äº mosdns å­˜åœ¨ç¼“å­˜ï¼Œé’ˆå¯¹ DDNS åŸŸåéœ€è¦åŠ è¿› `ddnslist.txt`ï¼Œä¸ç„¶ç”±äº IP æ›´æ–°ç¼“å­˜ä¸æ›´æ–°ä¼šå¯¼è‡´è®¿é—®å¤±è´¥ï¼š

```text
/mssb/mosdns/ddnslist.txt
```

#### å¼€å…³é…ç½®

- **å±è”½æ— è§£æç»“æœçš„ Aã€AAAA è¯·æ±‚åŠé»‘åå•**
  - é…ç½®æ–‡ä»¶ï¼š`/mssb/mosdns/sub_config/switch.yaml` ä¸­ `switch1`
  - UI ç•Œé¢ï¼šä¹Ÿå¯ä¿®æ”¹ï¼Œé‡å¯ä¸ä¼šå¤±æ•ˆ `/mssb/mosdns/rule/switch1.txt`
  - `'A'` - å¯ç”¨ï¼Œ`'B'` - ä¸å¯ç”¨

- **æ³„éœ²ç‰ˆæœ¬/ä¸æ³„éœ²ç‰ˆæœ¬å¼€å…³**
  - é…ç½®æ–‡ä»¶ï¼š`/mssb/mosdns/sub_config/switch.yaml` ä¸­ `switch3`
  - UI ç•Œé¢ï¼šä¹Ÿå¯ä¿®æ”¹ï¼Œé‡å¯ä¸ä¼šå¤±æ•ˆ `/mssb/mosdns/rule/switch3.txt`
  - `'A'` - æ³„éœ²ï¼Œ`'B'` - ä¸æ³„éœ²

> **æ³¨æ„**ï¼šPH ä½¬åœ¨ç•Œé¢åŠ äº†è½¯å¯åŠ¨ï¼Œæˆ‘è¿™ä¸ªé¡¹ç›®ä¼šç›‘å¬é…ç½®æ–‡ä»¶è¿›è¡Œç¡¬å¯åŠ¨ï¼Œæ‰€ä»¥æ²¡å•¥ç‰¹æ®Šæƒ…å†µè¿˜æ˜¯å»ºè®®æ”¹é…ç½®æ–‡ä»¶ç¨³å¦¥ï¼ŒUI åªè´Ÿè´£æ˜¾ç¤ºã€‚

### 6. è·¯ç”±é…ç½®

è¯·åœ¨ä¸»è·¯ç”±ä¸­æ·»åŠ ä»¥ä¸‹è·¯ç”±è§„åˆ™ï¼š

#### ä¸»è·¯ç”± DNS è®¾ç½® / DHCP DNS è®¾ç½®

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| DNS æœåŠ¡å™¨ | `{Debianä¸»æœºIP}` |

#### MosDNS å’Œ Mihomo fakeip è·¯ç”±

| ç›®æ ‡åœ°å€ | ç½‘å…³ |
|----------|------|
| 28.0.0.0/8 | `{Debianä¸»æœºIP}` |
| 8.8.8.8/32 | `{Debianä¸»æœºIP}` |
| 1.1.1.1/32 | `{Debianä¸»æœºIP}` |

#### Telegram è·¯ç”±

| ç›®æ ‡åœ°å€ | ç½‘å…³ |
|----------|------|
| 149.154.160.0/22 | `{Debianä¸»æœºIP}` |
| 149.154.164.0/22 | `{Debianä¸»æœºIP}` |
| 149.154.172.0/22 | `{Debianä¸»æœºIP}` |
| 91.108.4.0/22 | `{Debianä¸»æœºIP}` |
| 91.108.20.0/22 | `{Debianä¸»æœºIP}` |
| 91.108.56.0/22 | `{Debianä¸»æœºIP}` |
| 91.108.8.0/22 | `{Debianä¸»æœºIP}` |
| 95.161.64.0/22 | `{Debianä¸»æœºIP}` |
| 91.108.12.0/22 | `{Debianä¸»æœºIP}` |
| 91.108.16.0/22 | `{Debianä¸»æœºIP}` |
| 67.198.55.0/24 | `{Debianä¸»æœºIP}` |
| 109.239.140.0/24 | `{Debianä¸»æœºIP}` |

#### Netflix è·¯ç”±

| ç›®æ ‡åœ°å€ | ç½‘å…³ |
|----------|------|
| 207.45.72.0/22 | `{Debianä¸»æœºIP}` |
| 208.75.76.0/22 | `{Debianä¸»æœºIP}` |
| 210.0.153.0/24 | `{Debianä¸»æœºIP}` |
| 185.76.151.0/24 | `{Debianä¸»æœºIP}` |

## é¡¹ç›®æ¥æºå’Œå‚è€ƒ

- [https://github.com/herozmy/StoreHouse/tree/latest](https://github.com/herozmy/StoreHouse/tree/latest)
- æ„Ÿè°¢è‹±é›„ä½¬çš„è„šæœ¬æ•™ç¨‹
- æ„Ÿè°¢ Phil Horse å¤§ä½¬çš„ mosdns çš„ä¼˜åŒ–æ‘¸å™¶
- æ„Ÿè°¢ Jimmy Dada å¤§ä½¬æä¾› mosdns å‰ç«¯é¡µé¢
- æ„Ÿè°¢ mosdns/singbox/mihomo çš„å„ä½å¼€å‘å¤§ä½¬ä»¬

æ„Ÿè°¢æ‰€æœ‰æä¾›æ”¯æŒä¸çµæ„Ÿçš„å¼€æºä½œè€…ï¼
